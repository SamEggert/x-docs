<div id="v2-webhooks-api">
  # API Webhooks v2
</div>

<div id="overview">
  ## Aperçu
</div>

L’API Webhooks v2 permet aux développeurs de recevoir des notifications d’événements en temps réel provenant de comptes X via des messages JSON transmis par webhook. Cette API vous permet d’enregistrer et de gérer des webhooks, de développer des applications consommatrices pour traiter les événements et de garantir une communication sécurisée grâce aux contrôles de challenge-réponse (CRC) et aux en-têtes de signature.

<div id="feature-summary">
  ## Résumé des fonctionnalités
</div>

| Niveau | Tarification | Nombre de webhooks |
| :---: | :---: | :---: |
| Self-Serve Pro | 5 000 $/mois | 1 |
| Enterprise | [Contacter le service commercial](https://docs.x.com/resources/enterprise/forms/enterprise-api-interest#enterprise-access-form) | 5+ |

<div id="products-that-support-webhooks">
  ## Produits compatibles avec les webhooks
</div>

Voici les produits qui prennent actuellement en charge la diffusion d’événements via webhook :

- API d’activité de compte (AAA)  
- Flux filtré (prévu)

<div id="manage-webhooks">
  ## Gérer les webhooks
</div>

L’API Account Activity fournit des messages JSON via des webhooks chaque fois que des événements sont associés à des comptes X abonnés à votre service. X envoie ces activités à votre webhook enregistré. Dans les étapes suivantes, vous apprendrez à gérer les webhooks et les utilisateurs abonnés.

Vous apprendrez à enregistrer, afficher et supprimer des webhooks ainsi que des utilisateurs abonnés. Nous utiliserons de simples commandes cURL pour envoyer des requêtes aux différents endpoints de l’API. cURL est un outil en ligne de commande permettant d’envoyer ou de récupérer des requêtes en utilisant la syntaxe d’URL.

Plusieurs points nécessitent votre attention avant de pouvoir commencer à recevoir des événements de webhook dans votre application consommatrice d’événements. Comme décrit ci-dessous, vous devrez créer une application X, obtenir l’accès à l’API Account Activity et développer une application web qui consomme les événements de webhook. 

### 1\. Développer une application consommatrice de webhooks 

Pour enregistrer un nouveau webhook associé à votre application X, vous devez développer, déployer et héberger une application web qui reçoit les événements de webhook X et répond à nos requêtes de sécurité.

*Avant de commencer, nous vous recommandons de consulter nos [applications d’exemple](https://github.com/xdevplatform/account-activity-dashboard-enterprise/tree/master)\!*

* Créez une application web avec une URL HTTPS accessible publiquement qui servira de point de terminaison de webhook pour recevoir les événements.  
  * Le *chemin* de l’URI est entièrement à votre discrétion. Cet exemple serait valide : [https://mydomain.com/service/listen](https://mydomain.com/service/listen)  
  * Si vous consommez des webhooks provenant de différentes sources, un schéma courant est : [https://mydomain.com/webhook/twitter](https://mydomain.com/webhook/twitter)  
  * Notez que l’URL spécifiée ne peut pas inclure de port ([https://mydomain.com:5000/NoWorkie](https://mydomain.com:5000/NoWorkie)).
* Une première étape consiste à écrire du code qui reçoit une requête GET X Challenge Response Check (CRC) et y répond avec une réponse JSON correctement formatée.  
* Enregistrez votre URL de webhook. Vous effectuerez une requête POST vers le point de terminaison /2/webhooks avec l’URL dans le corps JSON. Lorsque vous ferez cette requête, X enverra une requête CRC à votre application web.  
* Lorsqu’un webhook est enregistré avec succès, la réponse inclut un identifiant de webhook. Cet identifiant sera nécessaire ultérieurement pour envoyer des requêtes aux produits qui prennent en charge les webhooks.  
* X enverra des requêtes POST contenant des événements à l’URL que vous avez enregistrée. Ces événements seront encodés en JSON. Voir [ici](https://docs.x.com/x-api/account-activity/introduction#account-activity-data-object-structure) des exemples de charges utiles JSON de webhook.

<div id="optional-use-xurl-for-testing">
  #### Facultatif : utiliser xurl pour les tests
</div>

À des fins de test, l’outil xurl prend désormais en charge les webhooks temporaires ! Installez la dernière version du projet [`xurl`](https://github.com/xdevplatform/xurl) depuis GitHub, configurez votre autorisation, puis exécutez :

```
xurl webhook start
```

Cela générera une URL de webhook publique temporaire, gérera automatiquement toutes les vérifications CRC et consignera tous les événements d’abonnement entrants. C’est un excellent moyen de valider votre configuration avant le déploiement. Exemple de sortie :

```
Starting webhook server with ngrok...
Enter your ngrok authtoken (leave empty to try NGROK_AUTHTOKEN env var):

Attempting to use NGROK_AUTHTOKEN environment variable for ngrok authentication.
Configuring ngrok to forward to local port: 8080
Ngrok tunnel established!
  Forwarding URL: https://<your-ngrok-subdomain>.ngrok-free.app -> localhost:8080

Use this URL for your X API webhook registration: https://<your-ngrok-subdomain>.ngrok-free.app/webhook

Starting local HTTP server to handle requests from ngrok tunnel (forwarded from https://<your-ngrok-subdomain>.ngrok-free.app)...
```

**Notes importantes**

* Lors de l’enregistrement de votre URL de webhook, votre application web doit utiliser le secret consommateur de votre application pour le chiffrement de la vérification CRC.

* Tous les Messages privés entrants seront remis via des webhooks. Tous les Messages privés envoyés via [POST /2/dm_conversations/with/:participant_id/messages](https://docs.x.com/x-api/direct-messages/send-a-new-message-to-a-user) seront également remis via des webhooks. Cela permet à votre application web d’être informée des Messages privés envoyés via un autre client.  
    
* Si vous avez plusieurs applications web partageant la même URL de webhook et le même utilisateur associé à chaque application, le même événement sera envoyé à votre webhook plusieurs fois (une fois par application web).  
    
* Dans certains cas, votre webhook peut recevoir des événements en double. Votre application webhook doit le tolérer et dédupliquer par ID d’événement.  
    
* Voir l’exemple de code :  
    
  * [Account Activity API Setup](https://github.com/m-rosinsky/XWebhookTest), une application web Node qui affiche les événements de webhook en utilisant le niveau Entreprise de l’Account Activity API.

### 2\. Sécurisation des webhooks 

Les API de X basées sur des webhooks proposent deux méthodes pour sécuriser votre serveur de webhook :

1. Les vérifications challenge-réponse permettent à X de confirmer que vous êtes bien propriétaire de l'application web recevant les événements de webhook.  
2. L’en-tête de signature de chaque requête POST vous permet de confirmer que X est bien à l’origine des webhooks entrants.

Voir la section Vérification CRC pour les exigences de mise en œuvre.

### 3\. L’API Webhooks

Les webhooks sont gérés via l’API de gestion des webhooks. Tous les points de terminaison requièrent une authentification OAuth2 App Only avec jeton Bearer.
---MDX_CONTENTEND---

<div id="adding-a-webhook">
  #### [Ajout d’un webhook](https://docs.x.com/x-api/webhooks/create-webhook-config)
</div>

**POST /2/webhooks**

**Description :**

Crée une configuration de webhook. Votre URL de rappel `https` accessible publiquement doit être transmise dans le corps JSON.
Commençons par enregistrer une nouvelle URL de webhook pour le contexte d’application donné.

**Authentification :**

Jeton Bearer OAuth2 App Only

* **Jeton Bearer** `<BEARER_TOKEN>` p. ex. `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**Paramètres (corps JSON) :**

```
{
    "url": "<your publicly accessible https callback url>"
}
```

* **URL** `<URL>` p. ex. `https://yourdomain.com/webhooks/twitter/`

**Requête :** Copiez la requête cURL suivante dans votre ligne de commande après avoir adapté les éléments suivants :

````
  ```
  curl --request POST --url 'https://api.twitter.com/2/webhooks?url=<URL>' --header 'authorization: Bearer <BEARER_TOKEN>'
  --data '{
"url": "https://yourdomain.com/webhooks/twitter"
          }'
  ```
````

**Réponses :**

**Succès (200 OK)**

Une réponse réussie indique que le webhook a été créé et que la vérification CRC initiale a abouti.

```
{
  "data": {
    "id": "<webhook_id>",
    "url": "<your callback url>",
    "valid": true,
    "created_at": "YYYY-mm-DDTHH:MM:ss.000Z"
  }
}
```

**Échec (400 Bad Request)**

Les échecs renvoient un objet d’erreur standard.

```
{
    "errors": [
      {
        "message": "<Reason>: <Details>"
      }
    ],
    "title": "Invalid Request",
    "detail": "One or more parameters to your request was invalid.",
    "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

Les raisons courantes d’échec incluent :

| Reason | Description |
| :---- | :---- |
| `CrcValidationFailed` | L’URL de rappel n’a pas répondu correctement à la vérification CRC (p. ex., délai dépassé, réponse incorrecte). |
| `UrlValidationFailed` | L’URL de rappel fournie ne répond pas aux exigences (p. ex., non `https`, format invalide). |
| `DuplicateUrlFailed` | Un webhook est déjà enregistré par votre application pour l’URL de rappel fournie. |
| `WebhookLimitExceeded` | Votre application a atteint le nombre maximal de configurations de webhook autorisées. |

<div id="viewing-a-webhook">
  #### [Afficher un webhook](https://docs.x.com/x-api/webhooks/get-a-list-of-webhook-configs-associated-with-a-client-app)
</div>

**GET /2/webhooks**

**Description :** Récupérer toutes les configurations de webhook associées à votre application (compte développeur).

**Authentification :**

Jeton Bearer OAuth2 App Only

- **Jeton Bearer** `<BEARER_TOKEN>` p. ex. `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

- **URL** `<URL>` p. ex. `https://yourdomain.com/webhooks/twitter/`

**Requête :** Exécutez la commande suivante pour récupérer toutes les URL de webhook enregistrées et leur statut pour l’application indiquée.

Copiez la requête cURL suivante dans votre terminal après avoir apporté les modifications suivantes :

````
  ```
  curl --request GET --url 'https://api.twitter.com/2/webhooks' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```
````

**Succès (200 OK)**

Renvoie une liste de configurations de webhook. La liste sera vide si aucun webhook n’est configuré.

*Exemple (avec un webhook configuré) :*

```
{
  "data": [
    {
      "created_at": "YYYY-mm-DDTHH:MM:ss.000Z",
      "id": "<webhook_id>",
      "url": "<callback url>",
      "valid": true
    }
  ],
  "meta": {
    "result_count": 1
  }
}
```

*Exemple (sans webhook configuré) :*

```
{
  "data": [],
  "meta": {
    "result_count": 0
  }
}
```

<div id="removing-a-webhook">
  #### [Supprimer un webhook](https://docs.x.com/x-api/webhooks/delete-webhook-config)
</div>

DELETE /2/webhooks/:webhook\_id

**Description :** Supprimez une configuration de webhook à l’aide de son `webhook_id` spécifique. L’ID peut être obtenu dans la réponse de création `POST /2/webhooks` ou la réponse de liste `GET /2/webhooks`.

**Authentification :**

Jeton Bearer OAuth2 App Only

* **Jeton Bearer** `<BEARER_TOKEN>` p. ex. `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**Paramètres de chemin :**

| Paramètre | Description |
| :---- | :---- |
| `webhook_id` | L’ID du webhook à supprimer. |

**Requête :** Exécutez la commande suivante pour retirer le webhook de la configuration de l’application indiquée.

Copiez la requête cURL suivante dans votre terminal après avoir apporté les modifications suivantes :

````
  ```
  curl --request DELETE --url 'https://api.twitter.com/2/webhooks/:WEBHOOK_ID' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```

  **Réponses :**
````

**Succès (200 OK)**

Renvoie une réponse JSON avec l’état "deleted" à true si la suppression a réussi.

*Exemple (suppression du webhook réussie) :*

```
{
  "data": {
    "deleted": true
  }
}
```

**Échec (400 Bad Request)**

| Raison | Description |
| :---- | :---- |
| `WebhookIdInvalid` | Le `webhook_id` fourni est introuvable ou n’est pas associé à votre application. |

<div id="validate-and-reenable-webhook">
  #### [Valider et réactiver le webhook](https://docs.x.com/x-api/webhooks/webhook-crc-check)
</div>

**PUT /2/webhooks/:webhook\_id**

**Description :** Déclenche la vérification de réponse au challenge (CRC) pour l’URL du webhook indiqué. Si la vérification réussit, renvoie 200 et réactive le webhook en définissant son statut sur `valid`.

**Authentification :**

Jeton Bearer OAuth2 App Only

* **Jeton Bearer** `<BEARER_TOKEN>` p. ex. `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**Paramètres de chemin :**

| Paramètre | Description |
| :---- | :---- |
| `webhook_id` | L’ID du webhook à valider. |

**Requête :** Exécutez la commande suivante pour valider le webhook à partir de la configuration de l’application fournie.

Copiez la requête cURL suivante dans votre terminal après avoir effectué les modifications suivantes :

````
  ```
  curl --request PUT --url 'https://api.twitter.com/2/webhooks/:WEBHOOK_ID' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```

  **Réponses :**
````

**Succès (200 OK)**

Une réponse 200 OK indique que la demande de vérification CRC a été *lancée*. Cela ne garantit **pas** que la vérification a réussi. Le champ `valid` dans la réponse reflète le statut *après* la tentative de vérification. Si la vérification CRC réussit, le statut du webhook sera mis à jour sur valid. Vous pouvez vérifier le statut actuel avec `GET /2/webhooks`.

```
{
  "data": {
    "valid": true // Indique le statut après l’achèvement de la tentative de vérification CRC
  }
}
```

**Échec (400 Bad Request)**

| Raison | Description |
| :---- | :---- |
| `WebhookIdInvalid` | Le `webhook_id` fourni est introuvable ou n’est pas associé à votre application. |
| `CrcValidationFailed` | L’URL de callback n’a pas répondu correctement à la demande de vérification CRC. |

### 4\. La vérification CRC 

La vérification Challenge Response (CRC) est la méthode utilisée par X pour confirmer que l’URL de rappel que vous avez fournie est valide et que vous la contrôlez.

**Quand la CRC est déclenchée :**

* Lors de l’enregistrement initial du webhook (`POST /2/webhooks`)  
* Toutes les heures par X à des fins de validation  
* Manuellement via `PUT /2/webhooks/:id`

Exemple : 

```
GET https://your-webhook-url.com/webhook?crc_token=challenge_string
```

Exemple de corps de réponse JSON :

```
{
  "response_token": "sha256=<base64_encoded_hmac_hash>"
}
```

**Comment construire la réponse :**

* Utilisez `crc_token` comme message  
* Utilisez le **secret consommateur** de l’application comme clé  
* Générez un HMAC SHA-256  
* Encodez le résultat en Base64

<div id="sample-apps">
  ## Exemples d’applications
</div>

* [Simple webhook server](https://github.com/m-rosinsky/XWebhookTest/blob/main/app.py)  
  * Un script Python autonome qui montre comment répondre au contrôle CRC et accepter des événements POST.  
* [Account Activity API sample dashboard](https://github.com/xdevplatform/account-activity-dashboard-enterprise/tree/master)  
  * Une application web écrite avec [bun.sh](https://bun.sh) qui vous permet de gérer des webhooks, des abonnements et de recevoir des événements en direct directement dans l’application.